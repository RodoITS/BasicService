using System;\nusing System.Collections.Generic;\nusing System.Net.Http;\nusing System.Threading.Tasks;\nusing Newtonsoft.Json;\nusing BasicService.Modules.WooCommerce;\n\nnamespace BasicService.Service\n{\n    public class WooCommerceApiService\n    {\n        public HttpClient _httpClient { get; set; }\n        public Uri _BaseUrl { get; private set; }\n        public string _CustomerKey { get; private set; }\n        public string _CustomerSecret { get; private set; }\n\n        public WooCommerceApiService(string baseUrl, string custKey, string custSercret)\n        {\n            _BaseUrl = new Uri($\"{baseUrl}/wp-json/wc/v3/\");\n            _CustomerKey = custKey;\n            _CustomerSecret = custSercret;\n\n            // Assicuro che _httpClient sia inizializzato con BaseAddress corretta\n            if (_httpClient == null)\n            {\n                _httpClient = new HttpClient\n                {\n                    BaseAddress = _BaseUrl,\n                    Timeout = TimeSpan.FromSeconds(60)\n                };\n            }\n        }\n\n        #region \"Products\"\n        public async Task<List<Product>> GetProductsAsync(string filter = \"\")\n        {\n            var products = new List<Product>();\n\n            try\n            {\n                string endpoint = \"products\";\n                if (!string.IsNullOrWhiteSpace(filter))\n                    endpoint += \"?\" + filter;\n\n                string jsonres = await CallApiAsync(HttpMethod.Get, endpoint);\n                if (!string.IsNullOrEmpty(jsonres))\n                {\n                    products = JsonConvert.DeserializeObject<List<Product>>(jsonres) ?? new List<Product>();\n                }\n            }\n            catch (Exception ex)\n            {\n                Console.WriteLine($\"GetProductsAsync error: {ex.Message}\");\n            }\n\n            return products;\n        }\n\n        public async Task<Product> CreateNewProductAsync(Product product)\n        {\n            if (product == null) throw new ArgumentNullException(nameof(product));\n\n            Product newproduct = new Product();\n            try\n            {\n                string jsoncat = JsonConvert.SerializeObject(product);\n                string jsonresponse = await CallApiAsync(HttpMethod.Post, \"products\", jsoncat);\n                if (!string.IsNullOrEmpty(jsonresponse))\n                    newproduct = JsonConvert.DeserializeObject<Product>(jsonresponse) ?? new Product();\n            }\n            catch (Exception ex)\n            {\n                Console.WriteLine($\"CreateNewProductAsync error: {ex.Message}\");\n                return new Product();\n            }\n\n            return newproduct;\n        }\n\n        public async Task<Product> UpdateProductAsync(long id, Product product)\n        {\n            if (product == null) throw new ArgumentNullException(nameof(product));\n\n            Product updated = new Product();\n            try\n            {\n                var settings = new JsonSerializerSettings { NullValueHandling = NullValueHandling.Ignore };\n                string jsoncat = JsonConvert.SerializeObject(product, settings);\n                // endpoint corretto: products/{id}\n                string jsonresponse = await CallApiAsync(new HttpMethod(\"PATCH\"), $\"products/{{id}}\", jsoncat);\n                if (!string.IsNullOrEmpty(jsonresponse))\n                    updated = JsonConvert.DeserializeObject<Product>(jsonresponse) ?? new Product();\n            }\n            catch (Exception ex)\n            {\n                Console.WriteLine($\"UpdateProductAsync error: {ex.Message}\");\n            }\n\n            return updated;\n        }\n\n        public async Task<bool> DeleteProductAsync(long id)\n        {\n            try\n            {\n                string jsonresponse = await CallApiAsync(HttpMethod.Delete, $\"products/{{id}}?force=true\");\n                return !string.IsNullOrEmpty(jsonresponse);\n            }\n            catch (Exception ex)\n            {\n                Console.WriteLine($\"DeleteProductAsync error: {ex.Message}\");\n                return false;\n            }\n        }\n        #endregion\n\n        #region \"Categories\"\n        public async Task<Category> CreateNewCategoryAsync(Category category)\n        {\n            Category newcategory = new Category();\n            try\n            {\n                string jsoncat = JsonConvert.SerializeObject(category);\n                string jsonresponse = await CallApiAsync(HttpMethod.Post, \"products/categories\", jsoncat);\n                if (!string.IsNullOrEmpty(jsonresponse))\n                    newcategory = JsonConvert.DeserializeObject<Category>(jsonresponse) ?? new Category();\n            }\n            catch (Exception ex)\n            {\n                Console.WriteLine($\"CreateNewCategoryAsync error: {ex.Message}\");\n            }\n\n            return newcategory;\n        }\n\n        public async Task<Category> UpdateCategoryAsync(long id, Category category)\n        {\n            Category updated = new Category();\n            try\n            {\n                var settings = new JsonSerializerSettings { NullValueHandling = NullValueHandling.Ignore };\n                string jsoncat = JsonConvert.SerializeObject(category, settings);\n                string jsonresponse = await CallApiAsync(new HttpMethod(\"PATCH\"), $\"products/categories/{{id}}\", jsoncat);\n                if (!string.IsNullOrEmpty(jsonresponse))\n                    updated = JsonConvert.DeserializeObject<Category>(jsonresponse) ?? new Category();\n            }\n            catch (Exception ex)\n            {\n                Console.WriteLine($\"UpdateCategoryAsync error: {ex.Message}\");\n            }\n\n            return updated;\n        }\n\n        public async Task<List<Category>> GetCategoriesAsync(string filter = \"\")\n        {\n            var categories = new List<Category>();\n\n            try\n            {\n                string endpoint = \"products/categories\";\n                if (!string.IsNullOrWhiteSpace(filter))\n                    endpoint += \"?\" + filter;\n\n                string jsonres = await CallApiAsync(HttpMethod.Get, endpoint);\n                if (!string.IsNullOrEmpty(jsonres))\n                {\n                    categories = JsonConvert.DeserializeObject<List<Category>>(jsonres) ?? new List<Category>();\n                }\n            }\n            catch (Exception ex)\n            {\n                Console.WriteLine($\"GetCategoriesAsync error: {ex.Message}\");\n            }\n\n            return categories;\n        }\n        #endregion\n\n        // CallApiAsync: implementazione robusta che aggiunge le credenziali consumer_key/consumer_secret\n        private async Task<string> CallApiAsync(HttpMethod method, string endpoint, string body = null)\n        {\n            try\n            {\n                // Se _CustomerKey/_CustomerSecret non sono nulli, aggiungo i param di query per autenticazione\n                var uri = endpoint;\n                if (!string.IsNullOrWhiteSpace(_CustomerKey) && !string.IsNullOrWhiteSpace(_CustomerSecret))\n                {\n                    // se endpoint gi√† ha querystring\n                    if (uri.Contains(\"?\")) uri += $\"&consumer_key={{_CustomerKey}}&consumer_secret={{_CustomerSecret}}\";\n                    else uri += $\"?consumer_key={{_CustomerKey}}&consumer_secret={{_CustomerSecret}}\";\n                }\n\n                using var request = new HttpRequestMessage(method, uri);\n\n                if (!string.IsNullOrEmpty(body))\n                    request.Content = new StringContent(body, System.Text.Encoding.UTF8, \"application/json\");\n\n                var resp = await _httpClient.SendAsync(request);\n                resp.EnsureSuccessStatusCode();\n                return await resp.Content.ReadAsStringAsync();\n            }\n            catch (HttpRequestException hre)\n            {\n                Console.WriteLine($\"CallApiAsync HTTP error: {{hre.Message}}.\");\n                return string.Empty;\n            }\n            catch (Exception ex)\n            {\n                Console.WriteLine($\"CallApiAsync error: {{ex.Message}}.\");\n                return string.Empty;\n            }\n        }\n    }\n}